# Notes an architecture

* Currently [ProseMirror Schema][] in use enforces `title author article` document structure. But parser fork of [prosemirror-markdown][] is fairly naive to handle customized markdown structure and making a proper one would take significant effort (that is hard to justify right now). Instead we define custom nodes like `title` and `author` that are equivalent of `heading` and `paragraph` but with different attributes and renderring. After we parse markdown document we then go and try to mold it into our custom structure turning first `heading` (assuming there is one) into `title` and turning following `paragraph` (assuming there is one) into `author`. Also since we reparse edited block we will run into situation where `author` field is edited there for reparsed producing `paragraph` instead, to preserve original structure we try to mold resulting node into the same shape as original input node `author` to make this conversion possible we abuse [`group`][nodespec group] and include `paragraph` so we can tell if one node can be cast into the other.

* We add custom `markup` [node attribute][nodespec attrs] which holds the markup info for instance `h1` will be represented as `heading` with `markup` set to `"#"`. We also add `markup` [mark attribute][markspec attrs] that allows use to know if strong text in original markdown was encoded as `**strong**` or `__strong__`. Whenever cursor is placed over marked text with `markup` attributes or a node with `markup` attributes we expand underlying fragment by adding `markup` marked with our custom `markup` mark. This way markup appears only when editing relevant fragment of the document and disappears on irrelevant pieces. We could likely simplify this by always having nodes for the markup just using `{display:none}` when cursor isn't in range, while that would work for nodes like `hr` and `a` it's not really going to work for `strong`, `em` and other inline nodes that prosemirror represents as marks and it's [structure][doc structure] does not quite map. For example following markdown `**hi _there_ friend**` will be result in `<strong("hello "), strong(em("there")), strong(" friend")>` rather (notice no nesting) so to render it as original markdown we find start and end of the range and only insert markup there. Alternative option could be to convert all marks into nodes but it seems like it would be fighting the prosemirror architecture. We also use custom `marked` attribute on all markers and nodes to be able to tell which fragments are expanded and which aren't so that expanding same range several times would not duplicate markup.

[prosemirror schema]: http://prosemirror.net/docs/guide/#schema
[prosemirror-markdown]: https://github.com/ProseMirror/prosemirror-markdown
[nodespec group]: http://prosemirror.net/docs/ref/#model.NodeSpec.group
[nodespec attrs]: http://prosemirror.net/docs/ref/#model.NodeSpec.attrs
[markspec attrs]: http://prosemirror.net/docs/ref/#model.MarkSpec.attrs
[doc structure]: http://prosemirror.net/docs/guide/#doc.structure
